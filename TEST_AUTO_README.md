# 智能自适应测试脚本使用指南

## 📋 概述

`test_auto.py` 是一个智能的自适应测试脚本，能够：
- ✅ **自动检测硬件能力**（CPU核心数、内存）
- ✅ **根据硬件动态调整测试强度**
- ✅ **在112线程机器上运行标准测试**（最多200 workers）
- ✅ **在500线程超级电脑上运行完整测试**（最多500 workers）
- ✅ **彩色终端实时显示进度和性能指标**
- ✅ **完整运行所有测试，不快速失败**

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install psutil colorama tabulate pytest
```

### 2. 运行测试

```bash
python test_auto.py
```

就这么简单！脚本会自动：
1. 检测您的硬件配置
2. 选择合适的测试级别
3. 运行所有测试
4. 显示彩色的实时进度
5. 生成详细的测试报告

---

## 📊 测试分级策略

| 硬件配置 | 测试级别 | 最大Workers | 测试场景 | 适用环境 |
|---------|---------|-----------|---------|---------|
| **≤64 核心** | Light | 100 | 基础功能测试 | 开发机、CI环境 |
| **65-256 核心** | Standard | 200 | 标准功能+性能测试 | **您的112线程机器** |
| **>256 核心** | Heavy | 500 | 完整压力测试 | **客户的500线程超级电脑** |

### 测试矩阵示例

#### Standard 级别（112线程机器）
```
单元测试: ✓ 所有单元测试
集成测试: 100, 150, 200 workers
压力测试: 100, 150, 200 workers（每个5个任务）
```

#### Heavy 级别（500线程超级电脑）
```
单元测试: ✓ 所有单元测试
集成测试: 100, 200, 300, 400, 500 workers
压力测试: 100, 200, 300, 400, 500 workers（每个10个任务）
```

---

## 💡 预期输出示例

### 在112线程机器上运行

```
================================================================================
                   unlock-processpool 智能自适应测试
================================================================================

 硬件检测

CPU线程数      112
内存容量       256.0 GB
测试级别       STANDARD
最大Workers    200
推荐Workers    200
说明           标准测试（112线程）

正在运行测试套件，请稍候...

 1. 单元测试

✓ 单元测试套件                                                     通过           2.34s     45 个测试通过

 2. 集成测试（基础功能验证）

▶ ProcessPoolExecutor(100 workers, 500 tasks)
✓ ProcessPoolExecutor(100 workers, 500 tasks)                      通过           3.15s     吞吐量: 158.7 任务/秒
▶ ProcessPoolExecutor(150 workers, 750 tasks)
✓ ProcessPoolExecutor(150 workers, 750 tasks)                      通过           5.23s     吞吐量: 143.4 任务/秒
▶ ProcessPoolExecutor(200 workers, 1000 tasks)
✓ ProcessPoolExecutor(200 workers, 1000 tasks)                     通过           8.12s     吞吐量: 123.2 任务/秒

 3. 压力测试（性能基准）

▶ ProcessPoolExecutor(100 workers, 500 tasks)
✓ ProcessPoolExecutor(100 workers, 500 tasks)                      通过           3.08s     吞吐量: 162.3 任务/秒
▶ ProcessPoolExecutor(150 workers, 750 tasks)
✓ ProcessPoolExecutor(150 workers, 750 tasks)                      通过           5.45s     吞吐量: 137.6 任务/秒
▶ ProcessPoolExecutor(200 workers, 1000 tasks)
✓ ProcessPoolExecutor(200 workers, 1000 tasks)                     通过           8.34s     吞吐量: 119.9 任务/秒

 测试汇总

总测试数    7
通过        7
失败        0
通过率      100.0%
总耗时      35.71s

【性能指标】
+-----------+----------------------+--------------+
|   Workers | 吞吐量(任务/秒)      | 内存(MB)     |
+===========+======================+==============+
|       100 | 162.3                | 45.2         |
+-----------+----------------------+--------------+
|       150 | 137.6                | 68.5         |
+-----------+----------------------+--------------+
|       200 | 119.9                | 92.1         |
+-----------+----------------------+--------------+

✓ 所有测试通过！
```

### 在500线程超级电脑上运行

```
 硬件检测

CPU线程数      512
内存容量       1024.0 GB
测试级别       HEAVY
最大Workers    500
推荐Workers    500
说明           完整测试（512线程超级电脑）

...

 3. 压力测试（性能基准）

✓ ProcessPoolExecutor(100 workers, 1000 tasks)                     通过           2.45s     吞吐量: 408.2 任务/秒
✓ ProcessPoolExecutor(200 workers, 2000 tasks)                     通过           4.12s     吞吐量: 485.4 任务/秒
✓ ProcessPoolExecutor(300 workers, 3000 tasks)                     通过           6.89s     吞吐量: 435.4 任务/秒
✓ ProcessPoolExecutor(400 workers, 4000 tasks)                     通过           10.23s    吞吐量: 391.0 任务/秒
✓ ProcessPoolExecutor(500 workers, 5000 tasks)                     通过           15.67s    吞吐量: 319.1 任务/秒

【性能指标】
+-----------+----------------------+--------------+
|   Workers | 吞吐量(任务/秒)      | 内存(MB)     |
+===========+======================+==============+
|       100 | 408.2                | 52.3         |
+-----------+----------------------+--------------+
|       200 | 485.4                | 98.7         |
+-----------+----------------------+--------------+
|       300 | 435.4                | 145.2        |
+-----------+----------------------+--------------+
|       400 | 391.0                | 192.5        |
+-----------+----------------------+--------------+
|       500 | 319.1                | 240.8        |
+-----------+----------------------+--------------+
```

---

## 🔧 高级用法

### 与pytest集成

```bash
# 先运行pytest单元测试
pytest tests/ -v

# 再运行自适应压力测试
python test_auto.py
```

### 与CI/CD集成

```yaml
# .github/workflows/tests.yml
- name: 运行智能自适应测试
  run: |
    pip install psutil colorama tabulate pytest
    python test_auto.py
  timeout-minutes: 60
```

### 手动调整测试级别（可选）

如果需要手动调整测试级别，可以修改 `test_auto.py` 中的分级逻辑：

```python
# 在 HardwareDetector.detect() 中修改阈值
if cpu_count <= 64:
    tier = "light"
elif cpu_count <= 256:  # 可以调整这个阈值
    tier = "standard"
else:
    tier = "heavy"
```

---

## 📝 输出文件

测试脚本当前只输出到终端，不生成文件。如果需要保存结果，可以：

```bash
# 重定向到文件
python test_auto.py > test_results.log 2>&1

# 或者使用tee同时显示和保存
python test_auto.py | tee test_results.log
```

---

## ⚠️ 注意事项

1. **首次运行**: 第一次运行可能需要更长时间，因为需要初始化进程池
2. **内存需求**: 500 workers测试需要至少8GB可用内存
3. **Windows专用**: 本测试脚本仅在Windows平台运行
4. **超时设置**: 如果测试超时，会自动标记为失败并继续运行下一个

---

## 🐛 故障排除

### 问题1: `ImportError: No module named 'psutil'`

**解决方案**:
```bash
pip install psutil colorama tabulate
```

### 问题2: 测试失败显示"pytest未安装"

**解决方案**:
```bash
pip install pytest
```

### 问题3: 性能数据异常低

**可能原因**:
- CPU温度过高导致降频
- 后台有其他占用资源的程序
- 磁盘I/O瓶颈

**解决方案**:
- 关闭不必要的后台程序
- 使用任务管理器查看资源占用
- 等待CPU温度降低后重新测试

---

## 📈 性能基准参考

### 正常性能范围（仅供参考）

| Workers | 预期吞吐量（任务/秒） | 112线程机器 | 500线程机器 |
|---------|-------------------|-----------|-----------|
| 100     | 150-200          | ✓         | ✓         |
| 200     | 70-150           | ✓         | ✓         |
| 300     | 50-100           | ❌        | ✓         |
| 500     | 30-80            | ❌        | ✓         |

**注意**: 实际性能取决于CPU型号、内存速度、任务类型等多个因素。

---

## 🔄 版本历史

- **v1.0** (2025-10-21): 初始版本
  - 自动硬件检测
  - 三级测试分级（light/standard/heavy）
  - 彩色终端输出
  - 性能指标收集

---

## 📧 反馈与支持

如有问题或建议，请在项目仓库提Issue。

**Author**: Half open flowers
**Email**: 1816524875@qq.com
