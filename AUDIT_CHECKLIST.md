# 审核检查清单（Quick Reference）

## 📋 快速导航

- [每次Commit前检查](#每次commit前检查)
- [每次PR前检查](#每次pr前检查)
- [代码修改检查](#代码修改检查)
- [测试编写检查](#测试编写检查)
- [性能优化检查](#性能优化检查)

---

## 每次Commit前检查

### ✅ 基础检查（必须）

```bash
# 1. 运行单元测试
pytest tests/unit/ -v
# ❌ 如果失败 → 修复后再commit

# 2. 检查代码覆盖率
pytest tests/ --cov=unlock_processpool --cov-report=term-missing
# ❌ 如果 <99% → 补充测试

# 3. 运行全部测试
pytest tests/ -v
# ❌ 如果有失败 → 修复后再commit

# 4. 黄金测试（如果存在）
pytest tests/golden/ -v
# ❌ 如果失败 → 回滚修改

# 5. 代码质量检查
pylint unlock_processpool/ --fail-under=9.0
# ❌ 如果 <9.0 → 修复警告
```

### ⚡ 快速检查（推荐）

```bash
# 一键检查脚本
python scripts/quick_check.py

# 或使用pre-commit hooks
git commit -m "..."  # 自动运行检查
```

---

## 每次PR前检查

### 📊 完整检查清单

#### 1. 测试覆盖

- [ ] 所有单元测试通过 (110+个)
- [ ] 所有集成测试通过
- [ ] 所有压力测试通过（如果修改了核心代码）
- [ ] 代码覆盖率 ≥99%
- [ ] 新增代码有对应的测试用例

#### 2. 代码质量

- [ ] pylint评分 ≥9.0
- [ ] mypy无错误 (`mypy unlock_processpool/ --strict`)
- [ ] 圈复杂度 <10 (`radon cc unlock_processpool/ -a`)
- [ ] 函数长度 <50行（核心函数）
- [ ] 无代码重复

#### 3. 文档

- [ ] 所有函数有docstring
- [ ] 逻辑契约已更新（如果修改了行为）
- [ ] README已更新（如果修改了API）
- [ ] CHANGELOG已更新

#### 4. 性能

- [ ] 性能基线对比：下降 <5%
- [ ] 内存使用无显著增长
- [ ] 无性能回归

#### 5. 安全

- [ ] 输入验证充分
- [ ] 无明显安全漏洞
- [ ] 异常处理完善

---

## 代码修改检查

### 修改前

- [ ] **阅读逻辑契约** (LOGIC_CONTRACTS.md)
- [ ] **理解不变量** - 哪些行为必须保持不变
- [ ] **编写黄金测试** - 锁定当前正确行为
- [ ] **声明修改意图** - 在PR描述中说明

### 修改中

- [ ] **每次只修改一个问题** - 避免多个改动混在一起
- [ ] **保持逻辑等价** - 重构不改变行为
- [ ] **增量提交** - 频繁commit，便于回滚
- [ ] **编写测试** - 为新功能编写测试

### 修改后

- [ ] **运行所有测试** - 确保无回归
- [ ] **更新契约文档** - 如果修改了行为
- [ ] **性能对比** - 确保无回归
- [ ] **Code Review** - 请求同行审查

---

## 测试编写检查

### 单元测试

- [ ] **测试命名清晰** - `test_功能_场景()`
- [ ] **一个测试一个断言** - 便于定位问题
- [ ] **独立性** - 不依赖其他测试
- [ ] **幂等性** - 可以重复运行
- [ ] **覆盖边界条件** - 空输入、最大值、最小值

### 集成测试

- [ ] **真实环境** - 使用真实的ProcessPoolExecutor
- [ ] **多种场景** - 不同workers数量
- [ ] **异常场景** - 测试错误处理
- [ ] **并发安全** - 多线程测试

### 测试质量

- [ ] **不过度依赖Mock** - 尽量使用真实对象
- [ ] **有意义的断言** - 不只是测试不抛异常
- [ ] **清晰的失败信息** - 使用自定义错误消息
- [ ] **文档化** - docstring说明测试目的

---

## 性能优化检查

### 优化前

- [ ] **建立性能基线**
  ```bash
  python test_auto.py > baseline_before.txt
  ```
- [ ] **识别瓶颈**
  ```bash
  python -m cProfile -o profile.stats your_script.py
  snakeviz profile.stats
  ```

### 优化中

- [ ] **逻辑等价性** - 优化不改变行为
- [ ] **增量优化** - 每次优化一个点
- [ ] **测试保护** - 每次优化都运行测试

### 优化后

- [ ] **性能提升验证** - 对比基线
  ```bash
  python test_auto.py > baseline_after.txt
  python scripts/compare_performance.py baseline_before.txt baseline_after.txt
  ```
- [ ] **无功能回归** - 所有测试通过
- [ ] **可读性没有下降** - 代码仍然清晰

---

## 特殊场景检查

### 修复BUG时

1. [ ] **编写失败的测试** - 证明BUG存在
2. [ ] **运行测试，确认失败**
3. [ ] **修复代码**
4. [ ] **运行测试，确认通过**
5. [ ] **运行全部测试，确认无回归**
6. [ ] **添加回归测试** - 防止BUG再次出现

### 重构代码时

1. [ ] **编写黄金测试** - 锁定当前行为
2. [ ] **小步重构** - 频繁commit
3. [ ] **持续验证** - 每次commit都测试
4. [ ] **保持可回滚** - 随时可以回退
5. [ ] **性能不下降** - 持续监控性能

### 添加新功能时

1. [ ] **TDD（测试驱动开发）** - 先写测试
2. [ ] **最小化修改** - 只添加必要的代码
3. [ ] **文档同步** - 更新README和API文档
4. [ ] **示例代码** - 提供使用示例

---

## 🚨 警告信号（立即停止并检查）

### 代码异味

- ⚠️ 函数超过50行 → 考虑拆分
- ⚠️ 圈复杂度 >10 → 必须重构
- ⚠️ 代码重复 >3次 → 提取公共函数
- ⚠️ 嵌套层级 >3层 → 提前返回或重构

### 测试问题

- 🔴 测试覆盖率下降 → 补充测试
- 🔴 测试运行时间 >5分钟 → 优化测试
- 🔴 测试间歇性失败 → 检查竞态条件
- 🔴 测试依赖顺序 → 改为独立测试

### 性能问题

- 🔴 性能下降 >5% → 回滚并重新评估
- 🔴 内存占用翻倍 → 检查内存泄漏
- 🔴 响应时间不稳定 → 检查并发问题

---

## 📝 Commit Message模板

### 格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type类型

- `feat`: 新功能
- `fix`: BUG修复
- `refactor`: 重构（不改变行为）
- `perf`: 性能优化
- `test`: 添加或修改测试
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）

### 示例

```bash
git commit -m "feat: 添加输入验证（BUG#4修复）

添加对handles参数的类型和范围验证：
- 检查类型是否为list/tuple
- 检查元素是否为int
- 检查数量是否超过508

测试: tests/unit/test_input_validation.py
契约: LOGIC_CONTRACTS.md#_hacked_wait
```

---

## 🎯 质量目标

| 指标 | 目标 | 当前 | 状态 |
|------|------|------|------|
| 测试覆盖率 | ≥99% | 97% | ⚠️ 需提升 |
| pylint评分 | ≥9.0 | 7.5 | ⚠️ 需提升 |
| 圈复杂度 | <10 | 20 | ❌ 需重构 |
| 已知BUG | 0 | 5 | ❌ 需修复 |
| 函数长度 | <50行 | 115行 | ❌ 需拆分 |

---

## 📞 快速帮助

### 如果测试失败

```bash
# 1. 查看失败的测试
pytest tests/ -v --tb=short

# 2. 只运行失败的测试
pytest tests/ -v --lf

# 3. 调试模式
pytest tests/ -v --pdb
```

### 如果性能下降

```bash
# 1. 对比基线
python scripts/compare_performance.py

# 2. 性能分析
python -m cProfile -o profile.stats test_auto.py
snakeviz profile.stats

# 3. 内存分析
python -m memory_profiler your_script.py
```

### 如果不确定

- 📖 阅读 AUDIT_PLAN_V2.md
- 📖 阅读 LOGIC_CONTRACTS.md
- 📖 阅读现有测试代码
- 💬 询问团队成员

---

**版本**: 1.0
**最后更新**: 2025-10-21
**下次更新**: 根据实践经验迭代
